= Mini Project - Automating MySQL Database migration to the cloud (AWS RDS MySQL instance)
:stylesheet: boot-darkly.css
:linkcss: boot-darkly.css
:image-url-ironhack: https://user-images.githubusercontent.com/23629340/40541063-a07a0a8a-601a-11e8-91b5-2f13e4e6b441.png
:my-name: Jorge Castro DAPT NOV2021
:description:
//:fn-xxx: Add the explanation foot note here bla bla
:toc:
:toc-title: In this mini-project I will be migrating a MySQL on-premises schema to a AWS MySQL instance and automate the process.
:toc-placement!:
:toclevels: 5
ifdef::env-github[]
:sectnums:
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:experimental:
:table-caption!:
:example-caption!:
:figure-caption!:
:idprefix:
:idseparator: -
:linkattrs:
:fontawesome-ref: http://fortawesome.github.io/Font-Awesome
:icon-inline: {user-ref}/#inline-icons
:icon-attribute: {user-ref}/#size-rotate-and-flip
:video-ref: {user-ref}/#video
:checklist-ref: {user-ref}/#checklists
:list-marker: {user-ref}/#custom-markers
:list-number: {user-ref}/#numbering-styles
:imagesdir-ref: {user-ref}/#imagesdir
:image-attributes: {user-ref}/#put-images-in-their-place
:toc-ref: {user-ref}/#table-of-contents
:para-ref: {user-ref}/#paragraph
:literal-ref: {user-ref}/#literal-text-and-blocks
:admon-ref: {user-ref}/#admonition
:bold-ref: {user-ref}/#bold-and-italic
:quote-ref: {user-ref}/#quotation-marks-and-apostrophes
:sub-ref: {user-ref}/#subscript-and-superscript
:mono-ref: {user-ref}/#monospace
:css-ref: {user-ref}/#custom-styling-with-attributes
:pass-ref: {user-ref}/#passthrough-macros
endif::[]
ifndef::env-github[]
:imagesdir: ./
endif::[]

image::{image-url-ironhack}[width=70]

{my-name}


                                                     
====
''''
====
toc::[]

{description}



== The tools to be used for the migration:

* MySQL Shell 8.0.26 - on Windows 
* MySQL Shell Dump & Load utilities
* AWS account
* AWS CLI v2 + JMESPath query language for JSON

On the AWS CLI I have set the default outputs as json however I will specify to --output table option so the output is more aesthetically pleasing whenever possible.

== Important considerations before loading the DB to AWS

Before moving to the next topic, the following are the parameters that has to be done so we are able to proceed with loading the database to AWS RDS.

A common error message when loading databases to AWS RDS is:

WARNING: Error processing schema •sakila• : You do not have the SUPER privilege and binary logging is enabled 
(you want to use the less safe variable) 
il.10adDump: You do not have the SUPER privilege and binary logging is enabled (you want to use t 
he less safe 10 variable) (MYSQLSH 1419) 
STUDENT 
> disconnect 

image::https://user-images.githubusercontent.com/63274055/159787786-84ca87ab-ade4-4e3b-9dba-1c28248e6055.png[width=800]
[NOTE]
====
* SUPER user privileges are required on the AWS RDS user to be able to load 
the database with "user defined SQL code". This can be achieved by creating 
a new Parameter Group, adding the log_bin_trust_function_creators and set its value to ’1′.

* Local_infile configuration needs to be enabled.
====

====
''''
====

== Creating a dump of the Sakila database (Backup)

To create the backup I used the MySQL Shell Schema Dump Utility

[NOTE]
====
 * MySQL shell must be run as Administrator, otherwise we will have an error message:

 `Util.dumpSchemas: Could not create directory
 \\?\C:\Program Files\MySQL\MySQL Shell 8.0\bin\sak-aws: 
 Access is denied. (RuntimeError)`

* The dump and load utilities must be run in JavaScript or Python mode.
* The minimum required set of privileges of the user account used to run the utility:
 `BACKUP_ADMIN`, `EVENT`, `RELOAD`, `SELECT`, `SHOW VIEW`, and `TRIGGER`.
====



First we log in to the MySQL Shell with the MySQL credentials. Then we find out the MySQL server version we are running (Top left of the shell). We will need that information to provision the RDS instance.

We run the following command to create the backup:



```js
\connect jorge@localhost
```
```js
util.dumpSchemas(["sakila"], "backup-sak-aws",{routines:true, compatibility: ["strip_definers", "strip_restricted_grants"]})
```
=== `util.dumpSchemas()` function explained

* `util.dumpSchemas(["sakila"]` Command to run the dump utility on the "schema" we choose.

* `"backup-sak-aws"` its the `directory` where the backup will be stored. If the directory does not exist, MySQL shell will create it. The directory will be created by default at:

`C:\Program Files\MySQL\MySQL Shell 8.0\bin`

* `routines:true` Option to include functions and store procedures for the schema in the dump.

* `compatibility` takes an array of strings to specify compatibility notations.

** `strip_definers` Database Cloud providers require special privileges to create these objects with a definer other than the user loading the schema. By stripping the DEFINER clause, these objects will be created with that default definer. Views and Routines will additionally have their SQL SECURITY clause changed from DEFINER to INVOKER. This ensures that the access permissions of the account querying or calling them are applied, instead of the user that created them. This should be sufficient for most users, but if your database security model requires that views and routines have more privileges than their invoker, you will need to manually modify the schema before loading it.

** `strip_restricted_grants` Certain privileges are restricted in Cloud Database Services. Attempting to create users granting these privileges would fail, so this option allows dumped GRANT statements to be stripped of these privileges.


image::https://user-images.githubusercontent.com/63274055/159908554-b69db053-101d-43b9-b7b1-603b4069d794.gif[width=800]


====
''''
====

== Tasks before provisioning the AWS RDS and loading (Windows Powershell)

=== Retrieving our current public IP address

We need this information in order to authorize connection to the AWS database  `port 3306` from our work or home. So we use the following command and we make a note of it:

```
(Invoke-WebRequest ifconfig.me/ip).Content.Trim()
```

====
''''
====


=== Verify support of our MySQL engine version from AWS

Here we verify the MySQL engine supported versions by AWS RDS, our MySQL database is v8.0.26

```bash
aws rds describe-db-engine-versions --engine mysql --engine-version 8.0.26
```

====
''''
====
=== Retrieve information on the DB parameter-groups

To be able to create a new parameter-group, the parameter-group-family is required.

```
aws rds describe-db-parameter-groups --output table
```


====
''''
====
=== Create a new parameter-group

* What is a parameter-group and Why do we need to create a new one?

For AWS RDS instances, we manage our database engine configuration through the use of parameters in a `DB parameter group`. DB parameter groups act as a container for engine configuration values that are applied to one or more DB instances.

In order to set wider privileges to the master account (SUPER user) and be able to load the backup, we have to create a new parameter-group. To modify the default existing parameter group is not allowed by AWS. It is best practice to create a new parameter-group, modify the parameter we need, then associate the new parameter-group to the new RDS instance. 

Amazon RDS is a managed service that does not provide SYS access (SUPER privileges). If binary logging is enabled on our MySQL DB instance, we need to set the `log_bin_trust_function_creators` parameter to true in the custom DB parameter group.

Once we are done with the migration, we can de-associate and parameter from the RDS instance and keep the default PG.

To create a new parameter-group:
```
aws rds create-db-parameter-group --db-parameter-group-name "superuser" --db-parameter-group-family "mysql8.0" --description "restore db from dump"
```

=== Modify the parameter-group 

To associate  the parameter `log_bin_trust_function_creators` and set its value to 1.

```bash
aws rds modify-db-parameter-group --db-parameter-group-name "superuser" --parameters "ParameterName='log_bin_trust_function_creators', ParameterValue=1,ApplyMethod=immediate"
```

After modifying a parameter group AWS recommends to wait at least 5 minutes before we proceed to create the new instance.

This allows Amazon RDS to fully complete the create action before the parameter group is used as the default for a new DB instance. However we want to add this new parameter-group instead of using it as default when creating the DB instance. This is why we have to modify the instance to add the parameter-group.




== Provisioning the RDS instance

Now we are ready to create our AWS RDS instance:

```bash
aws rds create-db-instance --db-instance-identifier sakila-aws --db-instance-class db.t2.micro --engine mysql --master-username "admindb" --master-user-password "my-password" --engine-version 8.0.26 --storage-type gp2 --publicly-accessible --allocated-storage 20
```


The output tells us the status of the RDS instance creation is `Creating`. Therefore the endpoint address is not available yet. It takes on average 10 minutes for the instance to be on `available` status

To obtain the endpoint of the RDS DB, this is possible with just calling a `describe-db-instances statement`. As the output of this command its quite lengthy, to only retrieve the basic information we need such as DBInstanceIdentifier , DBInstanceIdentifier , we can use the `--filter` or `--query` options to filter responses. As the --filter option is supported by a limited number of AWS commands and sub-commands, I prefer to use `--query`. This option can be used with all AWS commands and uses exclusively the `JMESPath` JSON scripting language.

`--query` operates in the actual JSON response and does not need support from the AWS API to support on the filtering. 

```bash
aws rds describe-db-instances --db-instance-identifier sakila-aws --query 'DBInstances[].Endpoint[].Address[]'
```

In this way we are getting the information we want. However with the help of the `db-instance-available` command, we can combine the three commands with pipes and ask AWS: 

Create my DB, wait until the InstanceStatus becomes `Available`, then tell me the endpoint address.

```bash
aws rds create-db-instance `
    --db-instance-identifier sakila-aws `
    --db-instance-class db.t2.micro `
    --engine mysql `
    --master-username "admindb" `
    --master-user-password "my-password" `
    --engine-version 8.0.26 `
    --storage-type gp2 `
    --publicly-accessible `
    --allocated-storage 20 | `
    aws rds wait db-instance-available `
    --db-instance-identifier sakila-aws | `
    aws rds describe-db-instances `
    --db-instance-identifier sakila-aws `
    --query "DBInstances[*].[Engine,DBInstanceIdentifier,EngineVersion,DBInstanceStatus,`
    Endpoint.Address,AllocatedStorage,DBInstanceClass,MasterUsername,Endpoint.Port]"
```

Now we have the database access credentials:

* User: admindb
* Endpoint: sakila-aws.cxrtws4xiav1.eu-central-1.rds.amazonaws.com
* Master-password: my-password

image::https://user-images.githubusercontent.com/63274055/160070801-db7beb24-b30a-4ba2-b08c-2b917c824d8f.png[width=800]
=== Associate the new parameter-group to the new RDS instance

```bash
aws rds modify-db-instance --db-instance-identifier "sakila-aws" --db-parameter-group-name "superuser"
```

====
''''
====


=== Obtain Security Group details

```powershell
aws rds describe-db-security-groups
```

=== Obtaining Security Group ID

```bash
aws ec2 describe-security-groups --group-names default --query 'SecurityGroups[*].[GroupId]'
```

=== Add inbound rule to security group

```bash
aws ec2 authorize-security-group-ingress --group-id sg-0f0fe8fea19b7b391 --protocol tcp --port 3306 --cidr 90.186.84.137/32
```



== Restoring the database to AWS RDS (MySQL Shell JS mode)

* Loading the database using the MySQL Shell `util.loadDump()` function to AWS RDS

```js
util.loadDump("sakila-aws", {threads: 16, deferTableIndexes: "all"})
```


====
''''
====




xref:Lab-xxxx[Top Section]

xref:Last-section[Bottom section]

// bla bla blafootnote:[{fn-xxx}]


////
.Unordered list title
* gagagagagaga
** gagagatrtrtrzezeze
*** zreu fhjdf hdrfj 
*** hfbvbbvtrtrttrhc
* rtez uezrue rjek  

.Ordered list title
. rwieuzr skjdhf
.. weurthg kjhfdsk skhjdgf
. djhfgsk skjdhfgs 
.. lksjhfgkls ljdfhgkd
... kjhfks sldfkjsdlk




[,sql]
----
----



[NOTE]
====
A sample note admonition.
====
 
TIP: It works!
 
IMPORTANT: Asciidoctor is awesome, don't forget!
 
CAUTION: Don't forget to add the `...-caption` document attributes in the header of the document on GitHub.
 
WARNING: You have no reason not to use Asciidoctor.

bla bla bla the 1NF or first normal form.footnote:[{1nf}]Then wen bla bla


====
- [*] checked
- [x] also checked
- [ ] not checked
-     normal list item
====
[horizontal]
CPU:: The brain of the computer.
Hard drive:: Permanent storage for operating system and/or user files.
RAM:: Temporarily stores information the CPU uses during operation.






bold *constrained* & **un**constrained

italic _constrained_ & __un__constrained

bold italic *_constrained_* & **__un__**constrained

monospace `constrained` & ``un``constrained

monospace bold `*constrained*` & ``**un**``constrained

monospace italic `_constrained_` & ``__un__``constrained

monospace bold italic `*_constrained_*` & ``**__un__**``constrained

////
