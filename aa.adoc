:stylesheet: boot-darkly.css
:linkcss: boot-darkly.css
:my-name: Jorge Castro DAPT NOV2021
:description:
//:fn-xxx: Add the explanation foot note here bla bla
ifdef::env-github[]
:sectnums:
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:experimental:
:table-caption!:
:example-caption!:
:figure-caption!:
:idprefix:
:idseparator: -
:linkattrs:
:fontawesome-ref: http://fortawesome.github.io/Font-Awesome
:icon-inline: {user-ref}/#inline-icons
:icon-attribute: {user-ref}/#size-rotate-and-flip
:video-ref: {user-ref}/#video
:checklist-ref: {user-ref}/#checklists
:list-marker: {user-ref}/#custom-markers
:list-number: {user-ref}/#numbering-styles
:imagesdir-ref: {user-ref}/#imagesdir
:image-attributes: {user-ref}/#put-images-in-their-place
:toc-ref: {user-ref}/#table-of-contents
:para-ref: {user-ref}/#paragraph
:literal-ref: {user-ref}/#literal-text-and-blocks
:admon-ref: {user-ref}/#admonition
:bold-ref: {user-ref}/#bold-and-italic
:quote-ref: {user-ref}/#quotation-marks-and-apostrophes
:sub-ref: {user-ref}/#subscript-and-superscript
:mono-ref: {user-ref}/#monospace
:css-ref: {user-ref}/#custom-styling-with-attributes
:pass-ref: {user-ref}/#passthrough-macros
endif::[]
ifndef::env-github[]
:imagesdir: ./
endif::[]


== Provisioning the RDS instance

Now we are ready to create our AWS RDS instance:

```
aws rds create-db-instance `
    --db-instance-identifier sakila-aws `
    --db-instance-class db.t2.micro --engine mysql `
    --master-username "admindb" `
    --master-user-password "my-password" `
    --engine-version 8.0.26 `
    --storage-type gp2 `
    --publicly-accessible `
    --allocated-storage 19
```


The output tells us the status of the RDS instance creation is `Creating`. Therefore the endpoint address is not available yet. It takes on average 10 minutes for the instance to be on `available` status

To obtain the endpoint of the RDS DB, this is possible with just calling a `describe-db-instances statement`. As the output of this command its quite lengthy, to only retrieve the basic information we need such as DBInstanceIdentifier, Endpoint, etc,  we can use the `--filter` or `--query` options to filter responses. As the --filter option is supported by a limited number of AWS commands and sub-commands, I prefer to use `--query`. This option can be used with all AWS commands and uses exclusively the `JMESPath` JSON scripting language.

`--query` operates in the actual JSON response and does not need support from the AWS API to support on the filtering. 

To query out new RDS:
```
aws rds describe-db-instances `
    --db-instance-identifier sakila-aws `
    --query 'DBInstances[].Endpoint[].Address[]'
```

In this way we are getting the information we want. However with the help of the `db-instance-available` command, we could combine the three commands with pipes and ask AWS the following:

"Create my DB, wait until the InstanceStatus becomes `Available`, then give me the basic information"

```
aws rds create-db-instance `
    --db-instance-identifier sakila-aws `
    --db-instance-class db.t2.micro `
    --engine mysql `
    --master-username "admindb" `
    --master-user-password "my-password" `
    --engine-version 8.0.26 `
    --storage-type gp2 `
    --publicly-accessible `
    --allocated-storage 20 | `
    aws rds wait db-instance-available `
    --db-instance-identifier sakila-aws | `
    aws rds describe-db-instances `
    --db-instance-identifier sakila-aws `
    --query "DBInstances[*].[Engine,DBInstanceIdentifier,EngineVersion,DBInstanceStatus,`
    Endpoint.Address,AllocatedStorage,DBInstanceClass,MasterUsername,Endpoint.Port]"
```


Now we have the database access credentials:

* User: admindb
* Endpoint: sakila-aws.cxrtws4xiav1.eu-central-1.rds.amazonaws.com
* Master-password: my-password

image::https://user-images.githubusercontent.com/63274055/160070801-db7beb24-b30a-4ba2-b08c-2b917c824d8f.png[width=800]
=== Associate the new parameter-group to the new RDS instance

```bash
aws rds modify-db-instance --db-instance-identifier "sakila-aws" --db-parameter-group-name "superuser"
```

====
''''
====


=== Obtain Security Group details

```bash
aws rds describe-db-security-groups
```

=== Obtaining Security Group ID

```bash
aws ec2 describe-security-groups `
    --group-names default `
    --query 'SecurityGroups[*].[GroupId]'
```

=== Add inbound rule to security group

```bash
aws ec2 authorize-security-group-ingress `
    --group-id sg-0f0fe8fea19b7b391 `
    --protocol tcp `
    --port 3306 `
    --cidr 52.47.83.107/32
```

